<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ç©ºæ‰‹ãƒ»è­·èº«è¡“å­¦ç¿’VRã‚·ã‚¹ãƒ†ãƒ </title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@d5f3f8/dist/aframe-extras.min.js"></script>
    <style>
      #ui-overlay {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1000;
        color: white;
        font-family: Arial, sans-serif;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        max-width: 300px;
      }
      #feedback-display {
        margin-top: 10px;
        padding: 10px;
        border-radius: 5px;
        font-weight: bold;
      }
      .feedback-good {
        background-color: rgba(0, 255, 0, 0.3);
        color: #00ff00;
      }
      .feedback-bad {
        background-color: rgba(255, 0, 0, 0.3);
        color: #ff6666;
      }
      .feedback-neutral {
        background-color: rgba(255, 255, 0, 0.3);
        color: #ffff66;
      }
    </style>
  </head>

  <body>
    <!-- UI ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="ui-overlay">
      <h3>ç©ºæ‰‹ãƒ»è­·èº«è¡“ç·´ç¿’</h3>
      <div>ç¾åœ¨ã®å‹: <span id="current-kata">åŸºæœ¬ç«‹ã¡</span></div>
      <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
      <div>é€£ç¶šæˆåŠŸ: <span id="combo">0</span></div>
      <div id="feedback-display" class="feedback-neutral">æº–å‚™ã—ã¦ãã ã•ã„</div>
      <button onclick="changeKata('punch')">æ­£æ‹³çªã</button>
      <button onclick="changeKata('block')">ä¸Šæ®µå—ã‘</button>
      <button onclick="changeKata('kick')">å‰è¹´ã‚Š</button>
      <button onclick="resetPractice()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <a-scene background="color: #87CEEB">
      <!-- ã‚¢ã‚»ãƒƒãƒˆã®å®šç¾© -->
      <a-assets>
        <!-- é“å ´3Dãƒ¢ãƒ‡ãƒ« - è¤‡æ•°ã®ãƒ‘ã‚¹ã‚’è©¦è¡Œ -->
        <a-asset-item id="dojo-model" src="public/gltf/karate/scene.gltf" 
                      crossorigin="anonymous"></a-asset-item>
        <!-- ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ« -->
        <a-asset-item id="instructor-model" src="public/gltf/karate/instructor.gltf" 
                      crossorigin="anonymous"></a-asset-item>
        <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ†ã‚¯ã‚¹ãƒãƒ£ -->
        <img id="tatami-texture" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxwYXR0ZXJuIGlkPSJ0YXRhbWkiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj4KICAgICAgPHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNCOEE4NjciLz4KICAgICAgPHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgZmlsbD0iI0E2OTY1NSIgc3Ryb2tlPSIjOEY3RTQ0IiBzdHJva2Utd2lkdGg9IjIiLz4KICAgIDwvcGF0dGVybj4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCN0YXRhbWkpIi8+Cjwvc3ZnPgo=" />
        <img id="wood-texture" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0id29vZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojOEI0NTEzO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3R5bGU9InN0b3AtY29sb3I6I0E0NjQyODtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojOEI0NTEzO3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCN3b29kKSIvPgo8L3N2Zz4K" />
      </a-assets>

      <!-- ãƒ¡ã‚¤ãƒ³é“å ´ãƒ¢ãƒ‡ãƒ« -->
      <a-entity 
        id="dojo-scene"
        gltf-model="#dojo-model"
        position="0 -2 0"
        scale="2 2 2"
        rotation="0 0 0"
        shadow="cast: true; receive: true">
      </a-entity>

      <!-- å¼·åŒ–ã•ã‚ŒãŸç…§æ˜ã‚·ã‚¹ãƒ†ãƒ  -->
      <!-- ç’°å¢ƒå…‰ï¼ˆå…¨ä½“ã‚’æ˜ã‚‹ãï¼‰ -->
      <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
      
      <!-- ãƒ¡ã‚¤ãƒ³ã®å¤ªé™½å…‰ -->
      <a-light 
        type="directional" 
        position="5 10 5" 
        color="#ffffff" 
        intensity="1.2"
        shadow="cast: true; shadowMapWidth: 2048; shadowMapHeight: 2048;">
      </a-light>
      
      <!-- è£œåŠ©ç…§æ˜ï¼ˆåå¯¾å´ã‹ã‚‰ï¼‰ -->
      <a-light 
        type="directional" 
        position="-5 8 -3" 
        color="#ffffff" 
        intensity="0.8">
      </a-light>
      
      <!-- ãƒã‚¤ãƒ³ãƒˆãƒ©ã‚¤ãƒˆï¼ˆé“å ´å†…éƒ¨ã‚’ç…§ã‚‰ã™ï¼‰ -->
      <a-light 
        type="point" 
        position="0 5 0" 
        color="#ffffff" 
        intensity="1.0" 
        distance="20">
      </a-light>
      
      <a-light 
        type="point" 
        position="3 4 -2" 
        color="#ffffff" 
        intensity="0.8" 
        distance="15">
      </a-light>
      
      <a-light 
        type="point" 
        position="-3 4 2" 
        color="#ffffff" 
        intensity="0.8" 
        distance="15">
      </a-light>

      <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç’°å¢ƒï¼ˆãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆï¼‰ -->
      <a-entity id="fallback-environment" visible="false">
        <!-- åºŠï¼ˆç•³é¢¨ï¼‰ -->
        <a-plane 
          position="0 0.01 0" 
          rotation="-90 0 0" 
          width="15" 
          height="15" 
          material="src: #tatami-texture; repeat: 5 5"
          shadow="receive: true">
        </a-plane>

        <!-- å£ï¼ˆæœ¨è£½ï¼‰ -->
        <a-plane 
          position="0 3 -7.5" 
          width="15" 
          height="6" 
          material="src: #wood-texture; color: #8B4513">
        </a-plane>
        <a-plane 
          position="-7.5 3 0" 
          rotation="0 90 0" 
          width="15" 
          height="6" 
          material="src: #wood-texture; color: #8B4513">
        </a-plane>
        <a-plane 
          position="7.5 3 0" 
          rotation="0 -90 0" 
          width="15" 
          height="6" 
          material="src: #wood-texture; color: #8B4513">
        </a-plane>

        <!-- å¤©äº• -->
        <a-plane 
          position="0 6 0" 
          rotation="90 0 0" 
          width="15" 
          height="15" 
          material="color: #654321">
        </a-plane>

        <!-- é¡ -->
        <a-plane 
          position="0 2.5 -7.4" 
          width="10" 
          height="4" 
          material="color: #C0C0C0; opacity: 0.8; metalness: 0.9; roughness: 0.1">
        </a-plane>

        <!-- ç…§æ˜ -->
        <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
        <a-light type="directional" position="0 5 2" color="#ffffff" intensity="0.8"></a-light>
      </a-entity>

      <!-- ç·´ç¿’ã‚¨ãƒªã‚¢ãƒãƒ¼ã‚«ãƒ¼ -->
      <a-plane 
        position="0 0.02 0" 
        rotation="-90 0 0" 
        width="0.1" 
        height="8" 
        color="#FFFFFF"
        opacity="0.7">
      </a-plane>

      <!-- æŒ‡å°è€…ãƒ¢ãƒ‡ãƒ« -->
      <a-entity
        id="instructor"
        gltf-model="#instructor-model"
        position="3 0 -2"
        scale="1 1 1"
        rotation="0 -30 0">
      </a-entity>

      <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æŒ‡å°è€…ï¼ˆãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆï¼‰ -->
      <a-entity
        id="fallback-instructor"
        visible="false"
        position="3 0.9 -2">
        
        <!-- ä½“ -->
        <a-box
          width="0.5" 
          height="1.8" 
          depth="0.3"
          material="color: #FFA500; opacity: 0.7">
          
          <!-- é ­ -->
          <a-sphere 
            position="0 1 0" 
            radius="0.15" 
            color="#FFDBAC">
          </a-sphere>
          
          <!-- è…• -->
          <a-entity id="instructor-left-arm">
            <a-cylinder 
              position="-0.35 0.5 0" 
              radius="0.05" 
              height="0.8" 
              color="#FFA500">
            </a-cylinder>
          </a-entity>
          
          <a-entity id="instructor-right-arm">
            <a-cylinder 
              position="0.35 0.5 0" 
              radius="0.05" 
              height="0.8" 
              color="#FFA500">
            </a-cylinder>
          </a-entity>
        </a-box>
      </a-entity>

      <!-- ç·´ç¿’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ -->
      <script>
        // ç·´ç¿’ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®
        for (let i = 0; i < 5; i++) {
          let x = (Math.random() - 0.5) * 6;
          let z = (Math.random() - 0.5) * 6;
          document.write(
            `<a-sphere class="target-marker" position="${x} 1.5 ${z}" radius="0.1" color="#FF4500" opacity="0.5" animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"></a-sphere>`
          );
        }
      </script>

      <!-- æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
      <a-entity 
        id="success-effect" 
        position="0 2 -1" 
        visible="false">
        <a-sphere 
          radius="0.2" 
          color="#00FF00" 
          opacity="0.8"
          animation="property: scale; to: 3 3 3; dur: 500; easing: easeOutQuad">
        </a-sphere>
      </a-entity>

      <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
      <a-entity id="cameraRig" position="0 0 3">
        <a-entity
          id="player"
          look-controls
          wasd-controls
          camera
          position="0 1.6 0">
        </a-entity>
        
        <a-entity 
          id="leftHand" 
          hand-tracking-controls="hand: left;"
          geometry="primitive: sphere; radius: 0.05"
          material="color: #FF6B6B; opacity: 0.8">
        </a-entity>
        
        <a-entity 
          id="rightHand" 
          hand-tracking-controls="hand: right;"
          geometry="primitive: sphere; radius: 0.05"
          material="color: #4ECDC4; opacity: 0.8">
        </a-entity>
      </a-entity>

      <!-- éŸ³å£°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
      <a-sound 
        id="success-sound" 
        src="url(data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+XqvmwhCjmLzu3mgzoIGGS57OihUgwOUarm7bllHgg2jdXzzn0vBSF2w+/eizEIHWq+8OJ/NwUheMPu34szCCFuw+/ejzMIHWq+8OJ/NwUheMPu34szCCFuw+/ejzMIGGS57OihUgwOUarm7bllHgg2jdXzzn0vBSF2w+/eizEIGGS57OihUgwOUarm7bllHgg2jdXzzn0vBSF2w+/eizEI)"
        autoplay="false">
      </a-sound>
      
      <a-sound 
        id="error-sound" 
        src="url(data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+XqvmwhCjmLzu3mgzoIGGS57OihUgwOUarm7bllHgg2jdXzzn0vBSF2w+/eizEI)"
        autoplay="false">
      </a-sound>
    </a-scene>

    <script>
      // 3Dãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿çŠ¶æ…‹ã®ç®¡ç†
      let dojoModelLoaded = false;
      let instructorModelLoaded = false;

      // DOMè¦ç´ ã®å–å¾—
      const dojoScene = document.getElementById('dojo-scene');
      const fallbackEnvironment = document.getElementById('fallback-environment');
      const instructor = document.getElementById('instructor');
      const fallbackInstructor = document.getElementById('fallback-instructor');
      const leftHand = document.getElementById('leftHand');
      const rightHand = document.getElementById('rightHand');
      const successEffect = document.getElementById('success-effect');
      const successSound = document.getElementById('success-sound');
      const errorSound = document.getElementById('error-sound');
      
      // UIè¦ç´ 
      const currentKataDisplay = document.getElementById('current-kata');
      const scoreDisplay = document.getElementById('score');
      const comboDisplay = document.getElementById('combo');
      const feedbackDisplay = document.getElementById('feedback-display');

      // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      dojoScene.addEventListener('model-error', function (e) {
        console.log('é“å ´ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
        console.log('ä»£æ›¿ãƒ‘ã‚¹ã‚’è©¦è¡Œä¸­...');
        
        // ä»£æ›¿ãƒ‘ã‚¹ã§å†è©¦è¡Œ
        const alternativePaths = [
          'gltf/karate/scene.gltf',
          './gltf/karate/scene.gltf',
          'karate/scene.gltf',
          './karate/scene.gltf'
        ];
        
        let pathIndex = 0;
        function tryNextPath() {
          if (pathIndex < alternativePaths.length) {
            console.log(`Trying path: ${alternativePaths[pathIndex]}`);
            dojoScene.setAttribute('gltf-model', alternativePaths[pathIndex]);
            pathIndex++;
          } else {
            console.log('å…¨ã¦ã®ä»£æ›¿ãƒ‘ã‚¹ãŒå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç’°å¢ƒã‚’è¡¨ç¤º');
            fallbackEnvironment.setAttribute('visible', true);
          }
        }
        
        setTimeout(tryNextPath, 1000);
      });

      dojoScene.addEventListener('model-loaded', function () {
        console.log('é“å ´ãƒ¢ãƒ‡ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        dojoModelLoaded = true;
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç’°å¢ƒã‚’éè¡¨ç¤º
        fallbackEnvironment.setAttribute('visible', false);
      });

      instructor.addEventListener('model-error', function () {
        console.log('ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤º');
        fallbackInstructor.setAttribute('visible', true);
      });

      instructor.addEventListener('model-loaded', function () {
        console.log('ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        instructorModelLoaded = true;
      });

      // WebSocketæ¥ç¶šï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
      let ws;
      try {
        ws = new WebSocket('wss://localhost:3001');
        ws.onopen = function() {
          console.log('WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ');
        };
        ws.onmessage = function(event) {
          console.log('å—ä¿¡:', event.data);
        };
      } catch (error) {
        console.log('WebSocketæ¥ç¶šãªã—ã§ãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œ');
      }

      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
      let currentKata = 'basic';
      let score = 0;
      let combo = 0;
      let lastCheckTime = 0;
      let isPerformingKata = false;

      // å‹ã®å®šç¾©
      const kataDefinitions = {
        basic: {
          name: 'åŸºæœ¬ç«‹ã¡',
          positions: {
            leftHand: { x: 0, y: 1.2, z: 0, tolerance: 0.3 },
            rightHand: { x: 0, y: 1.2, z: 0, tolerance: 0.3 }
          }
        },
        punch: {
          name: 'æ­£æ‹³çªã',
          positions: {
            leftHand: { x: -0.2, y: 1.4, z: 0.2, tolerance: 0.2 },
            rightHand: { x: 0.2, y: 1.4, z: -0.4, tolerance: 0.2 }
          }
        },
        block: {
          name: 'ä¸Šæ®µå—ã‘',
          positions: {
            leftHand: { x: -0.3, y: 1.7, z: -0.2, tolerance: 0.2 },
            rightHand: { x: 0.3, y: 1.7, z: -0.2, tolerance: 0.2 }
          }
        },
        kick: {
          name: 'å‰è¹´ã‚Š',
          positions: {
            leftHand: { x: -0.2, y: 1.3, z: 0.1, tolerance: 0.3 },
            rightHand: { x: 0.2, y: 1.3, z: 0.1, tolerance: 0.3 }
          }
        }
      };

      // è·é›¢è¨ˆç®—é–¢æ•°
      function calculateDistance(pos1, pos2) {
        return Math.sqrt(
          Math.pow(pos1.x - pos2.x, 2) +
          Math.pow(pos1.y - pos2.y, 2) +
          Math.pow(pos1.z - pos2.z, 2)
        );
      }

      // å‹ã®è©•ä¾¡é–¢æ•°
      function evaluateKata() {
        const currentTime = Date.now();
        if (currentTime - lastCheckTime < 100) return;
        lastCheckTime = currentTime;

        const leftPos = leftHand.getAttribute('position');
        const rightPos = rightHand.getAttribute('position');
        
        if (!leftPos || !rightPos) return;

        const kata = kataDefinitions[currentKata];
        if (!kata) return;

        const leftDistance = calculateDistance(leftPos, kata.positions.leftHand);
        const leftCorrect = leftDistance <= kata.positions.leftHand.tolerance;

        const rightDistance = calculateDistance(rightPos, kata.positions.rightHand);
        const rightCorrect = rightDistance <= kata.positions.rightHand.tolerance;

        const overallCorrect = leftCorrect && rightCorrect;

        if (overallCorrect) {
          if (!isPerformingKata) {
            isPerformingKata = true;
            score += 10;
            combo += 1;
            showFeedback('å®Œç’§ã§ã™ï¼', 'good');
            playSuccessEffect();
            
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({
                type: 'kata_success',
                kata: currentKata,
                score: score,
                combo: combo,
                timestamp: Date.now()
              }));
            }
          }
        } else {
          if (isPerformingKata) {
            isPerformingKata = false;
            combo = 0;
            showFeedback('å§¿å‹¢ã‚’ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„', 'bad');
            playErrorSound();
          } else {
            let guidance = '';
            if (!leftCorrect) guidance += 'å·¦æ‰‹ã®ä½ç½®ã‚’èª¿æ•´ ';
            if (!rightCorrect) guidance += 'å³æ‰‹ã®ä½ç½®ã‚’èª¿æ•´';
            showFeedback(guidance || 'ç·´ç¿’ä¸­...', 'neutral');
          }
        }

        updateUI();
      }

      // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
      function showFeedback(message, type) {
        feedbackDisplay.textContent = message;
        feedbackDisplay.className = `feedback-${type}`;
      }

      // UIæ›´æ–°
      function updateUI() {
        currentKataDisplay.textContent = kataDefinitions[currentKata].name;
        scoreDisplay.textContent = score;
        comboDisplay.textContent = combo;
      }

      // æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      function playSuccessEffect() {
        successEffect.setAttribute('visible', true);
        successEffect.setAttribute('animation', 'property: scale; from: 1 1 1; to: 2 2 2; dur: 500');
        successSound.components.sound.playSound();
        
        setTimeout(() => {
          successEffect.setAttribute('visible', false);
          successEffect.setAttribute('scale', '1 1 1');
        }, 500);
      }

      // ã‚¨ãƒ©ãƒ¼éŸ³å†ç”Ÿ
      function playErrorSound() {
        errorSound.components.sound.playSound();
      }

      // å‹å¤‰æ›´é–¢æ•°
      function changeKata(newKata) {
        currentKata = newKata;
        isPerformingKata = false;
        showFeedback(`${kataDefinitions[newKata].name}ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'neutral');
        updateUI();
        
        demonstrateKata(newKata);
      }

      // æŒ‡å°è€…ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
      function demonstrateKata(kata) {
        const positions = kataDefinitions[kata].positions;
        
        // 3Dãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®å‡¦ç†
        if (instructorModelLoaded) {
          // glTFãƒ¢ãƒ‡ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ï¼ˆå®Ÿè£…ã¯3Dãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã«ä¾å­˜ï¼‰
          console.log(`Demonstrating kata: ${kata} with 3D model`);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆã®å‡¦ç†
          const leftArm = document.getElementById('instructor-left-arm');
          const rightArm = document.getElementById('instructor-right-arm');
          
          if (leftArm && rightArm) {
            leftArm.setAttribute('animation', 
              `property: position; to: ${positions.leftHand.x} ${positions.leftHand.y - 0.9} ${positions.leftHand.z}; dur: 1000`);
            rightArm.setAttribute('animation', 
              `property: position; to: ${positions.rightHand.x} ${positions.rightHand.y - 0.9} ${positions.rightHand.z}; dur: 1000`);
          }
        }
      }

      // ãƒªã‚»ãƒƒãƒˆé–¢æ•°
      function resetPractice() {
        score = 0;
        combo = 0;
        currentKata = 'basic';
        isPerformingKata = false;
        showFeedback('ç·´ç¿’ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'neutral');
        updateUI();
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      leftHand.addEventListener('componentchanged', function (event) {
        if (event.detail.name === 'position') {
          evaluateKata();
        }
      });

      rightHand.addEventListener('componentchanged', function (event) {
        if (event.detail.name === 'position') {
          evaluateKata();
        }
      });

      // å®šæœŸçš„ãªè©•ä¾¡
      setInterval(evaluateKata, 200);

      // ========== æ•™å¸«ã‚ã‚Šå­¦ç¿’å®Ÿè£… ==========
      // è¨“ç·´ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯è“„ç©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
      function generateTrainingData() {
        return [
            // æ­£æ‹³çªãï¼ˆæˆåŠŸä¾‹ï¼‰
            { kata: 'punch', leftX: -0.2, leftY: 1.4, leftZ: 0.2, rightX: 0.2, rightY: 1.4, rightZ: -0.4, success: true },
            { kata: 'punch', leftX: -0.18, leftY: 1.38, leftZ: 0.18, rightX: 0.22, rightY: 1.42, rightZ: -0.38, success: true },
            { kata: 'punch', leftX: -0.15, leftY: 1.35, leftZ: 0.15, rightX: 0.25, rightY: 1.45, rightZ: -0.35, success: true },
    
            // æ­£æ‹³çªãï¼ˆå¤±æ•—ä¾‹ï¼‰
            { kata: 'punch', leftX: -0.5, leftY: 1.2, leftZ: 0.5, rightX: 0.1, rightY: 1.2, rightZ: -0.1, success: false },
            { kata: 'punch', leftX: 0.1, leftY: 1.8, leftZ: 0.1, rightX: -0.1, rightY: 1.8, rightZ: 0.1, success: false },
    
            // ä¸Šæ®µå—ã‘ï¼ˆæˆåŠŸä¾‹ï¼‰
            { kata: 'block', leftX: -0.3, leftY: 1.7, leftZ: -0.2, rightX: 0.3, rightY: 1.7, rightZ: -0.2, success: true },
            { kata: 'block', leftX: -0.28, leftY: 1.68, leftZ: -0.18, rightX: 0.32, rightY: 1.72, rightZ: -0.22, success: true },
    
            // ä¸Šæ®µå—ã‘ï¼ˆå¤±æ•—ä¾‹ï¼‰
            { kata: 'block', leftX: -0.1, leftY: 1.3, leftZ: 0.1, rightX: 0.1, rightY: 1.3, rightZ: 0.1, success: false },
            { kata: 'block', leftX: -0.6, leftY: 1.9, leftZ: -0.5, rightX: 0.6, rightY: 1.9, rightZ: -0.5, success: false },
    
            // å‰è¹´ã‚Šï¼ˆæˆåŠŸä¾‹ï¼‰
            { kata: 'kick', leftX: -0.2, leftY: 1.3, leftZ: 0.1, rightX: 0.2, rightY: 1.3, rightZ: 0.1, success: true },
            { kata: 'kick', leftX: -0.18, leftY: 1.28, leftZ: 0.08, rightX: 0.22, rightY: 1.32, rightZ: 0.12, success: true },
    
            // å‰è¹´ã‚Šï¼ˆå¤±æ•—ä¾‹ï¼‰
            { kata: 'kick', leftX: -0.4, leftY: 1.1, leftZ: 0.4, rightX: 0.4, rightY: 1.1, rightZ: 0.4, success: false }
        ];
    }

    // ç‰¹å¾´é‡æŠ½å‡º
    function extractFeatures(leftPos, rightPos, kata) {
        const distance = calculateDistance(leftPos, rightPos);
        const height = (leftPos.y + rightPos.y) / 2;
        const symmetry = Math.abs(leftPos.x + rightPos.x); // å¯¾ç§°æ€§
        const depth = (leftPos.z + rightPos.z) / 2;
  
        return [
            leftPos.x, leftPos.y, leftPos.z,
            rightPos.x, rightPos.y, rightPos.z,
            distance, height, symmetry, depth
        ];
    }

    // ç°¡æ˜“æ±ºå®šæœ¨ãƒ¢ãƒ‡ãƒ«ï¼ˆæ•™å¸«ã‚ã‚Šå­¦ç¿’ã®å®Ÿè£…ï¼‰
    class KarateAI {
        constructor() {
            this.trainingData = generateTrainingData();
            this.model = this.train();
            console.log('ğŸ¤– AIå­¦ç¿’å®Œäº†ï¼è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°:', this.trainingData.length);
        }
  
        train() {
            // ç°¡å˜ãªæ±ºå®šæœ¨é¢¨ã®ãƒ«ãƒ¼ãƒ«ã‚’è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å­¦ç¿’
            const rules = {};
    
            this.trainingData.forEach(data => {
                if (!rules[data.kata]) rules[data.kata] = { success: [], fail: [] };
      
                const features = extractFeatures(
                    { x: data.leftX, y: data.leftY, z: data.leftZ },
                    { x: data.rightX, y: data.rightY, z: data.rightZ },
                    data.kata
                );
      
                if (data.success) {
                    rules[data.kata].success.push(features);
                } else {
                    rules[data.kata].fail.push(features);
                }
            });
    
            return rules;
        }
  
        predict(leftPos, rightPos, kata) {
            const features = extractFeatures(leftPos, rightPos, kata);
            const kataRules = this.model[kata];
    
            if (!kataRules) return { accuracy: 0.5, prediction: 'unknown', confidence: 0.5 };
    
            // æˆåŠŸä¾‹ã¨ã®é¡ä¼¼åº¦è¨ˆç®—
            let bestSuccessScore = 0;
            kataRules.success.forEach(successFeatures => {
                const similarity = this.calculateSimilarity(features, successFeatures);
                bestSuccessScore = Math.max(bestSuccessScore, similarity);
            });
    
            // å¤±æ•—ä¾‹ã¨ã®é¡ä¼¼åº¦è¨ˆç®—
            let bestFailScore = 0;
            kataRules.fail.forEach(failFeatures => {
                const similarity = this.calculateSimilarity(features, failFeatures);
                bestFailScore = Math.max(bestFailScore, similarity);
            });
    
            // äºˆæ¸¬çµæœ
            const isSuccess = bestSuccessScore > bestFailScore;
            const confidence = Math.abs(bestSuccessScore - bestFailScore);
            const accuracy = isSuccess ? bestSuccessScore : (1 - bestFailScore);
    
            return {
                accuracy: Math.min(0.95, Math.max(0.1, accuracy)),
                prediction: isSuccess ? 'success' : 'needs_improvement',
                confidence: Math.min(0.9, confidence),
                aiAdvice: this.generateAdvice(kata, features, isSuccess)
            };
        }
  
        calculateSimilarity(features1, features2) {
            // ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ãƒ™ãƒ¼ã‚¹ã®é¡ä¼¼åº¦
            let sumSquares = 0;
            for (let i = 0; i < Math.min(features1.length, features2.length); i++) {
                sumSquares += Math.pow(features1[i] - features2[i], 2);
            }
            const distance = Math.sqrt(sumSquares);
            return Math.exp(-distance); // è·é›¢ã‚’é¡ä¼¼åº¦ã«å¤‰æ›
        }
  
        generateAdvice(kata, features, isSuccess) {
            if (isSuccess) {
                return [
                    'ç´ æ™´ã‚‰ã—ã„å‹•ãã§ã™ï¼',
                    'ã“ã®èª¿å­ã§ç¶™ç¶šã—ã¾ã—ã‚‡ã†',
                    'AIãŒé«˜ã„ç²¾åº¦ã‚’æ¤œå‡ºã—ã¾ã—ãŸ'
                ];
            }
    
            const advice = {
                punch: [
                    'å³æ‰‹ã‚’ã‚‚ã†å°‘ã—å‰ã«å‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†',
                    'è…°ã®å›è»¢ã‚’æ„è­˜ã—ã¦ãã ã•ã„', 
                    'å·¦æ‰‹ã®å¼•ãæ‰‹ã‚’ã—ã£ã‹ã‚Šã¨'
                ],
                block: [
                    'ä¸¡æ‰‹ã®é«˜ã•ã‚’æƒãˆã¾ã—ã‚‡ã†',
                    'è‚˜ã®è§’åº¦ã‚’æ„è­˜ã—ã¦ãã ã•ã„',
                    'ä¸Šæ®µã¸ã®æ„è­˜ã‚’é«˜ã‚ã¦'
                ],
                kick: [
                    'æ‰‹ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ•´ãˆã¾ã—ã‚‡ã†',
                    'è»¸è¶³ã®å®‰å®šã‚’æ„è­˜ã—ã¦',
                    'è¹´ã‚Šã®æº–å‚™å§¿å‹¢ã‚’ç¢ºèª'
                ]
            };
    
            return advice[kata] || ['åŸºæœ¬å§¿å‹¢ã‚’è¦‹ç›´ã—ã¾ã—ã‚‡ã†'];
        }
  
        // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«æ–°ã—ã„ä¾‹ã‚’è¿½åŠ ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­¦ç¿’ï¼‰
        addTrainingExample(leftPos, rightPos, kata, success) {
            this.trainingData.push({
                kata: kata,
                leftX: leftPos.x, leftY: leftPos.y, leftZ: leftPos.z,
                rightX: rightPos.x, rightY: rightPos.y, rightZ: rightPos.z,
                success: success
            });
    
            // ãƒ¢ãƒ‡ãƒ«ã‚’å†è¨“ç·´
            this.model = this.train();
            console.log('ğŸ“š AIå­¦ç¿’æ›´æ–°ï¼æ–°ã—ã„è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°:', this.trainingData.length);
    
            // CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚ä¿å­˜ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ï¼‰
            this.saveToCSV();
        }
  
        saveToCSV() {
            // å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã“ã“ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            console.log('ğŸ’¾ è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’CSVã«ä¿å­˜ï¼ˆå®Ÿè£…äºˆå®šï¼‰');
        }
    }

    // AIã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
    let karateAI;

    // æ—¢å­˜ã® evaluateKata é–¢æ•°ã‚’ AIå¯¾å¿œç‰ˆã«æ›´æ–°
    function evaluateKataWithAI() {
        const currentTime = Date.now();
        if (currentTime - lastCheckTime < 100) return;
        lastCheckTime = currentTime;

        const leftPos = leftHand.getAttribute('position');
        const rightPos = rightHand.getAttribute('position');
  
        if (!leftPos || !rightPos || !karateAI) return;

        // AIäºˆæ¸¬å®Ÿè¡Œ
        const aiResult = karateAI.predict(leftPos, rightPos, currentKata);
  
        const overallCorrect = aiResult.prediction === 'success' && aiResult.accuracy > 0.7;

        if (overallCorrect) {
            if (!isPerformingKata) {
                isPerformingKata = true;
                score += Math.round(aiResult.accuracy * 20); // AIç²¾åº¦ã«åŸºã¥ãã‚¹ã‚³ã‚¢
                combo += 1;
      
                // AIå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«æˆåŠŸä¾‹ã‚’è¿½åŠ 
                karateAI.addTrainingExample(leftPos, rightPos, currentKata, true);
      
                showFeedback(`ğŸ¤– AIè©•ä¾¡: ${(aiResult.accuracy * 100).toFixed(1)}% - ${aiResult.aiAdvice[0]}`, 'good');
                playSuccessEffect();
      
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'ai_kata_success',
                        kata: currentKata,
                        aiAccuracy: aiResult.accuracy,
                        aiConfidence: aiResult.confidence,
                        score: score,
                        combo: combo,
                        timestamp: Date.now()
                    }));
                }
            }
        } else {
            if (isPerformingKata) {
                isPerformingKata = false;
                combo = 0;
      
                // AIå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«æ”¹å–„ä¾‹ã‚’è¿½åŠ 
                karateAI.addTrainingExample(leftPos, rightPos, currentKata, false);
      
                const advice = aiResult.aiAdvice[Math.floor(Math.random() * aiResult.aiAdvice.length)];
                showFeedback(`ğŸ¤– AIææ¡ˆ: ${advice}`, 'bad');
                playErrorSound();
            } else {
                const guidance = `AIç²¾åº¦: ${(aiResult.accuracy * 100).toFixed(1)}% - ${aiResult.aiAdvice[0]}`;
                showFeedback(guidance, 'neutral');
            }
        }

        updateUI();
    }

    // AIåˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æ›´æ–°
    document.addEventListener('DOMContentLoaded', function() {
        // AIåˆæœŸåŒ–
        karateAI = new KarateAI();
  
        // æ—¢å­˜ã®evaluateKataå‘¼ã³å‡ºã—ã‚’AIç‰ˆã«ç½®ãæ›ãˆ
        const originalInterval = setInterval(evaluateKata, 200);
        clearInterval(originalInterval);
  
        // AIè©•ä¾¡ã®å®šæœŸå®Ÿè¡Œ
        setInterval(evaluateKataWithAI, 200);
  
        console.log('ğŸ¥‹ ç©ºæ‰‹AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ï¼');
    });

    // ========== VRã‚´ãƒ¼ã‚°ãƒ«ä¸è¦ã®ãƒ‡ãƒ¢æ©Ÿèƒ½ ==========

    // ãƒ‡ãƒ¢ç”¨ã®æ‰‹ã®ä½ç½®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    function simulateHandMovement(kata) {
        const positions = kataDefinitions[kata].positions;
  
        // ãƒ©ãƒ³ãƒ€ãƒ ãªå¤‰å‹•ã‚’åŠ ãˆã¦ãƒªã‚¢ãƒ«ãªå‹•ãã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        const noise = () => (Math.random() - 0.5) * 0.1;
  
        const simulatedLeft = {
            x: positions.leftHand.x + noise(),
            y: positions.leftHand.y + noise(), 
            z: positions.leftHand.z + noise()
        };
  
        const simulatedRight = {
            x: positions.rightHand.x + noise(),
            y: positions.rightHand.y + noise(),
            z: positions.rightHand.z + noise()
        };
  
        return { left: simulatedLeft, right: simulatedRight };
    }

    // ãƒ‡ãƒ¢å®Ÿè¡Œé–¢æ•°
    function runKataDemo(kata) {
        console.log(`ğŸ¯ ${kata}ã®ãƒ‡ãƒ¢ã‚’é–‹å§‹ã—ã¾ã™`);
  
        // æ‰‹ã®ä½ç½®ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        const positions = simulateHandMovement(kata);
  
        // AIè©•ä¾¡ã‚’å®Ÿè¡Œ
        if (karateAI) {
            const aiResult = karateAI.predict(positions.left, positions.right, kata);
    
            // UIæ›´æ–°
            const accuracy = (aiResult.accuracy * 100).toFixed(1);
            const feedback = `ğŸ­ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ - AIè©•ä¾¡: ${accuracy}% - ${aiResult.aiAdvice[0]}`;
    
            if (aiResult.prediction === 'success') {
                score += Math.round(aiResult.accuracy * 20);
                combo += 1;
                showFeedback(feedback, 'good');
                playSuccessEffect();
            } else {
                showFeedback(feedback, 'bad');
            }
    
            updateUI();
    
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ãƒ­ã‚°
            console.log('ğŸ“Š AIåˆ†æçµæœ:', {
                kata: kata,
                accuracy: accuracy + '%',
                prediction: aiResult.prediction,
                confidence: (aiResult.confidence * 100).toFixed(1) + '%',
                advice: aiResult.aiAdvice
            });
        }
    }

    // è‡ªå‹•ãƒ‡ãƒ¢æ©Ÿèƒ½
    function startAutoDemo() {
        const katas = ['punch', 'block', 'kick'];
        let currentIndex = 0;
  
        const demoInterval = setInterval(() => {
            const kata = katas[currentIndex];
            changeKata(kata);
    
            setTimeout(() => {
                runKataDemo(kata);
            }, 1000);
    
            currentIndex = (currentIndex + 1) % katas.length;
    
            // 10å›å®Ÿè¡Œã—ãŸã‚‰åœæ­¢
            if (currentIndex === 0) {
                setTimeout(() => {
                    clearInterval(demoInterval);
                    showFeedback('ğŸ­ è‡ªå‹•ãƒ‡ãƒ¢çµ‚äº†', 'neutral');
                }, 2000);
            }
        }, 3000);
  
        showFeedback('ğŸ­ è‡ªå‹•ãƒ‡ãƒ¢é–‹å§‹ï¼AIãŒå„å‹ã‚’è©•ä¾¡ã—ã¾ã™', 'neutral');
    }

    // ãƒœã‚¿ãƒ³ã«ãƒ‡ãƒ¢æ©Ÿèƒ½ã‚’è¿½åŠ 
    function enhanceButtons() {
        // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’ãƒ‡ãƒ¢å¯¾å¿œã«
        const buttons = document.querySelectorAll('#ui-overlay button');
        buttons.forEach(button => {
            const originalOnClick = button.onclick;
    
            button.onclick = function() {
                if (originalOnClick) originalOnClick();
      
                // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ãƒ‡ãƒ¢å®Ÿè¡Œ
                setTimeout(() => {
                    if (button.textContent.includes('æ­£æ‹³çªã')) runKataDemo('punch');
                    if (button.textContent.includes('ä¸Šæ®µå—ã‘')) runKataDemo('block');
                    if (button.textContent.includes('å‰è¹´ã‚Š')) runKataDemo('kick');
                }, 500);
            };
        });
  
        // è‡ªå‹•ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const autoButton = document.createElement('button');
        autoButton.textContent = 'ğŸ¤– AIè‡ªå‹•ãƒ‡ãƒ¢';
        autoButton.onclick = startAutoDemo;
        autoButton.style.backgroundColor = '#4CAF50';
        autoButton.style.color = 'white';
        autoButton.style.marginTop = '10px';
  
        document.getElementById('ui-overlay').appendChild(autoButton);
    }

    // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºç”¨ãƒ‘ãƒãƒ«è¿½åŠ 
    function addStatsPanel() {
        const statsPanel = document.createElement('div');
        statsPanel.id = 'stats-panel';
        statsPanel.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        max-width: 250px;
        z-index: 1001;
        `;
  
        statsPanel.innerHTML = `
        <h4>ğŸ¤– AIå­¦ç¿’çµ±è¨ˆ</h4>
        <div id="training-data-count">è¨“ç·´ãƒ‡ãƒ¼ã‚¿: èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="model-accuracy">ãƒ¢ãƒ‡ãƒ«ç²¾åº¦: è¨ˆç®—ä¸­...</div>
        <div id="predictions-made">äºˆæ¸¬å®Ÿè¡Œå›æ•°: 0</div>
        <div id="current-kata-stats">ç¾åœ¨ã®å‹: -</div>
        `;
  
        document.body.appendChild(statsPanel);
    }

    // çµ±è¨ˆæ›´æ–°
    let predictionCount = 0;
    // çµ±è¨ˆæ›´æ–°ã‚’å®‰å…¨ã«ä¿®æ­£
    function updateStats() {
        if (karateAI) {
            const trainingElement = document.getElementById('training-data-count');
            const predictionsElement = document.getElementById('predictions-made');
            const kataElement = document.getElementById('current-kata-stats');
    
            // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°
            if (trainingElement) {
                trainingElement.textContent = `è¨“ç·´ãƒ‡ãƒ¼ã‚¿: ${karateAI.trainingData.length}ä»¶`;
            }
            if (predictionsElement) {
                predictionsElement.textContent = `äºˆæ¸¬å®Ÿè¡Œå›æ•°: ${predictionCount}`;
            }
            if (kataElement) {
                kataElement.textContent = `ç¾åœ¨ã®å‹: ${kataDefinitions[currentKata].name}`;
            }
        }
    }

    // AIè©•ä¾¡é–¢æ•°ã‚’æ‹¡å¼µï¼ˆçµ±è¨ˆã‚«ã‚¦ãƒ³ãƒˆä»˜ãï¼‰
    const originalEvaluateKataWithAI = evaluateKataWithAI;
    evaluateKataWithAI = function() {
        predictionCount++;
        updateStats();
        return originalEvaluateKataWithAI();
    };

    // åˆæœŸåŒ–æ™‚ã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            enhanceButtons();
            addStatsPanel();
            updateStats();
    
            console.log('ğŸ­ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰æº–å‚™å®Œäº†ï¼');
            console.log('ğŸ’¡ ä½¿ã„æ–¹:');
            console.log('   1. å‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨AIãƒ‡ãƒ¢ãŒå®Ÿè¡Œã•ã‚Œã¾ã™');
            console.log('   2. ğŸ¤– AIè‡ªå‹•ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³ã§é€£ç¶šå®Ÿè¡Œ');
            console.log('   3. å³ä¸Šã®ãƒ‘ãƒãƒ«ã§AIçµ±è¨ˆã‚’ç¢ºèª');
        }, 1000);
    });

      // åˆæœŸåŒ–
      updateUI();
      showFeedback('æ‰‹ã®å‹•ãã‚’èªè­˜ä¸­...', 'neutral');

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç’°å¢ƒã‚’è¡¨ç¤ºï¼ˆãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„å ´åˆï¼‰
      setTimeout(() => {
        if (!dojoModelLoaded) {
          console.log('é“å ´ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
          console.log('æ‰‹å‹•ã§ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:');
          console.log('- public/gltf/karate/scene.gltf ãŒå­˜åœ¨ã™ã‚‹ã‹');
          console.log('- HTTPSã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹');
          console.log('- CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹');
          
          // æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦ç›´æ¥ãƒ‘ã‚¹æŒ‡å®šã‚’è©¦è¡Œ
          console.log('æœ€å¾Œã®è©¦è¡Œ...');
          dojoScene.setAttribute('gltf-model', 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf');
        }
        if (!instructorModelLoaded) {
          console.log('ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º');
          fallbackInstructor.setAttribute('visible', true);
        }
      }, 8000); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’8ç§’ã«å»¶é•·
    </script>
  </body>
</html>